<link rel="stylesheet" type="text/css" href="https://religionandstory.com/common/css/modal.css"/>

<div id="marketModal" class="modal-wrapper">
    <div class="modal-foreground">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modalHeader" class="subtitle">Market</span>
                <span id="close" class="close">&times;</span>
            </div>
            <div id="modalBody" class="modal-body">
                <div style="margin-bottom: 2em">
                    <div><label for="resourceACount" style="display: inline-block; width: 6em">Aether     </label><input id="resourceACount" type="number" class="input" style="width: 3em; margin: .1em; padding: .1em" min="0" placeholder="0"> of <span id="resourceAMax">0</span></div>
                    <div><label for="resourceCCount" style="display: inline-block; width: 6em">Chronotine </label><input id="resourceCCount" type="number" class="input" style="width: 3em; margin: .1em; padding: .1em" min="0" placeholder="0"> of <span id="resourceCMax">0</span></div>
                    <div><label for="resourceUCount" style="display: inline-block; width: 6em">Unobtanium </label><input id="resourceUCount" type="number" class="input" style="width: 3em; margin: .1em; padding: .1em" min="0" placeholder="0"> of <span id="resourceUMax">0</span></div>
                    <button class="button" style="margin-top: .4em; padding: .1em .5em" onclick="convert()">Convert</button>
                </div>
                <div style="margin-bottom: 1em">
                    Units (<span id="unitsCost">0</span>WB):
                    <div id="unitsWrapper"></div>
                </div>
                <div style="margin-bottom: 1em">
                    <div><label for="technologySelect"  style="display: inline-block; width: 6em">Technology </label><select id="technologySelect" class="select" style="width: 13em; margin: .1em; padding: .1em" onchange="technologyChange()"></select> (<span id="technologyCost">0</span>WB)</div>
                    <div><label for="doctrineSelect"    style="display: inline-block; width: 6em">Doctrine   </label><select id="doctrineSelect"   class="select" style="width: 13em; margin: .1em; padding: .1em" onchange="doctrineChange()"></select> (<span id="doctrineCost">0</span>WB)</div>
                    <div style="margin-top: .5em">
                        Gardens (<span id="gardensCost">0</span>WB):
                        <div id="gardens"></div>
                    </div>
                    <div style="margin-top: .5em">
                        Auction Lots (<span id="auctionsCost">0</span>WB):
                        <div id="auctions"></div>
                    </div>
                </div>
                <div style="margin-bottom: 1em">
                    <div><label for="cardCount" style="display: inline-block; width: 10em">Chaos Cards (4WB) </label><input id="cardCount" type="number" class="input" style="width: 3em; margin: .1em; padding: .1em" min="0" max="7" placeholder="0" onchange="chaosChange()"> (<span id="cardCost">0</span>WB)</div>
                </div>
                <div style="margin-bottom: 1em">
                    <div><span style="font-weight: bold">Grand Total: </span><span id="totalCost">0</span>WB</div>
                    <button id="purchase" class="button" style="margin-top: .4em; padding: .1em .5em" onclick="purchase()">Purchase</button>
                </div>
                <div style="margin-bottom: 1em">
                    <!-- Inquisitions-->
                    <!-- Special Chaos Card abilities-->
                </div>
            </div>
            <div id="modalSubmit" class="modal-submit center">
                <button id="closeButton" class="button" style="width: 10em" onclick="closeOutMarketModal()">Close</button>
            </div>
        </div>
    </div>
    <div class="modal-background"></div>
</div>

<script>
    let marketModalValues;
    let marketModalCallback;
    let marketTotal;

    function openMarketModal( currentPlayer, callback ) {
        marketModalValues = currentPlayer;
        marketModalCallback = callback;

        populateUnits();
        populateAdvancements();
        populateData();

        id("marketModal").style.display = "block";
        setCloseHandlersJS( "marketModal" );
        blurBackground();
    }

    function populateUnits() {
        let wrapper = id('unitsWrapper');
        wrapper.innerHTML = "";
        for ( let i = 0; i < UNIT_TYPES.length; i++ ) {
            let unit = UNIT_TYPES[i];
            const id = "unitCount" + i;
            let div = document.createElement( "DIV" );
            let label = document.createElement( "LABEL" );
            label.for = id;
            label.style.display = "inline-block";
            label.style.width = "10em";
            label.innerText = unit.name + " (" + unit.cost + "WB) ";
            let input = document.createElement( "INPUT" );
            input.id = id;
            input.name = "unitCounts";
            input.type = "number";
            input.classList.add( "input" );
            input.style.width = "3em";
            input.style.margin = ".1em";
            input.style.padding = ".1em";
            input.min = "0";
            if ( unit.max ) {
                input.max = unit.max;
                input.disabled = unit.max === marketModalValues.units.filter( u => u.id === unit.id ).length;
            }
            input.placeholder = "0";
            input.onchange = unitChange;
            div.appendChild( label );
            div.appendChild( input );
            wrapper.appendChild( div );
        }
    }

    function populateAdvancements() {
        const availableTechnologies = TECHNOLOGIES.filter( t => !marketModalValues.advancements.technologies.includes( t.id ) );
        const availableDoctrines = DOCTRINES.filter( d => !marketModalValues.advancements.doctrines.includes( d.id ) );
        const availableGardens = GARDENS.filter( g => !marketModalValues.advancements.gardens.includes( g.id ) );
        const availableAuctions = AUCTIONS.filter( a => !marketModalValues.advancements.auctions.includes( a.id ) );
        //todo 10 - Add "None" option to Common?
        //todo - make Gardens act almost exactly like auctions because they too can be locked if there are fewer than 2 districts
        addAllToSelect( 'technologySelect', [{text: "None", value: null}].concat( availableTechnologies.map( (t) => { return {text: t.name, value: t.id}; } ) ) );
        addAllToSelect( 'doctrineSelect', [{text: "None", value: null}].concat( availableDoctrines.map( (d) => { return {text: d.name, value: d.id}; } ) ) );
        populateAdvancementCheckboxes( availableGardens, "gardens", function( item ) { return item.costFunction( currentPlayer.districts.tileIds.length ) + "WB"; } );
        populateAdvancementCheckboxes( availableAuctions, "auctions", function( item ) { return item.getCostOrLocked( game.players ); } );
    }

    function populateAdvancementCheckboxes( data, wrapperId, costFunction ) {
        let wrapper = id( wrapperId );
        wrapper.innerHTML = "";
        for ( let i = 0; i < data.length; i++ ) {
            const id = wrapperId + "-" + data[i].id;
            let div = document.createElement( "DIV" );
            let input = document.createElement( "INPUT" );
            input.id = id;
            input.name = wrapperId;
            input.type = "checkbox";
            input.onchange = function() { advancementChange( data, costFunction, wrapperId ); };
            let label = document.createElement( "LABEL" );
            let cost = costFunction( data[i] );
            let isLocked = Number.isNaN(parseInt(cost));
            label.for = id;
            label.innerHTML = data[i].name + " (" + cost + ")";
            input.disabled = isLocked;
            div.appendChild( input );
            div.appendChild( label );
            wrapper.appendChild( div );
        }
    }

    function populateData() {
        const aetherCount     = getAetherCount(     marketModalValues.resources );
        const chronotineCount = getChronotineCount( marketModalValues.resources );
        const unobtaniumCount = getUnobtaniumCount( marketModalValues.resources );
        id('resourceAMax').max       = aetherCount;
        id('resourceAMax').innerText = aetherCount + "";
        id('resourceCMax').max       = chronotineCount;
        id('resourceCMax').innerText = chronotineCount + "";
        id('resourceUMax').max       = unobtaniumCount;
        id('resourceUMax').innerText = unobtaniumCount + "";
    }

    function unitChange() {
        let total = 0;
        let unitCounts = nm('unitCounts');
        for ( let i = 0; i < unitCounts.length; i++ ) {
            total += UNIT_TYPES[i].cost * unitCounts[i].value;
        }
        id('unitsCost').innerText = total + "";
        updateTotal();
    }

    function technologyChange() {
        let total = ( getSelectedOption( 'technologySelect' ).index ) * TECHNOLOGIES[0].costFunction();
        id('technologyCost').innerText = total + "";
        updateTotal();
    }

    function doctrineChange() {
        let total = ( getSelectedOptionValue( 'doctrineSelect' ).index ) * DOCTRINES[0].costFunction();
        id('doctrineCost').innerText = total + "";
        updateTotal();
    }

    function advancementChange( data, costFunction, wrapperId ) {
        let total = 0;
        let advancementChecks = nm(wrapperId);
        for ( let i = 0; i < advancementChecks.length; i++ ) {
            if ( advancementChecks[i].checked ) {
                total += parseInt( costFunction( data[i] ) );
            }
        }
        id(wrapperId + 'Cost').innerText = total + "";
        updateTotal();
    }

    function chaosChange() {
        let total = 4 * id('cardCount').value;
        id('cardCost').innerText = total + "";
        updateTotal();
    }

    function updateTotal() {
        marketTotal = parseInt( id('unitsCost').innerText ) + parseInt( id('technologyCost').innerText ) + parseInt( id('doctrineCost').innerText ) + parseInt( id('gardensCost').innerText ) + parseInt( id('auctionsCost').innerText ) + parseInt( id('cardCost').innerText );
        id('totalCost').innerText = marketTotal + "";
    }

    function convert() {
        //todo
    }

    function purchase() {
        if ( !isCurrentPlayerTurn() ) {
            showToaster( "Cannot purchase out of turn" );
        }
        else if ( marketTotal > marketModalValues.warBucks ) {
            showToaster( "Cannot afford purchase" );
        }
        else {
            const maxAdvancements = 7;
            const maxCards = 7;
            const advancementsInCartCount =
                getSelectedOption( "technologySelect" ).index +
                getSelectedOption( "doctrineSelect" ).index +
                nm('gardens').filter( c => c.checked ).length +
                nm('auctions').filter( c => c.checked ).length;
            if ( advancementsInCartCount + marketModalValues.turn.purchasedAdvancementCount > maxAdvancements ) {
                showToaster( "Cannot purchase more than " + maxAdvancements + " advancements" );
            }
            else if ( parseInt( id('cardCount').value ) + marketModalValues.turn.purchasedCardCount > maxCards ) {
                showToaster( "Cannot purchase more than " + maxCards + " cards" );
            }
            else {
                let isValid = true;
                let unitCounts = nm('unitCounts');
                for ( let i = 0; i < unitCounts.length; i++ ) {
                    const unitInput = unitCounts[i];
                    const currentCount = marketModalValues.units.filter( u => u.id === (i + "") ).length + unitInput.value;
                    if ( unitInput.max && currentCount > unitInput.max ) {
                        isValid = false;
                        showToaster( "Too many units of a type" );
                    }
                }

                if ( isValid ) {
                    marketModalValues.warBucks -= marketTotal;
                    assignPurchases();
                    closeOutMarketModal();
                }
            }
        }
    }

    function assignPurchases() {
        let unitInputs = nm('unitCounts');
        for ( let i = 0; i < unitInputs.length; i++ ) {
            const unitInput = unitInputs[i];
            const unitCount = parseInt( unitInput.value ) || 0;
            const unitTypeId = i + "";
            if ( unitCount > 0 ) {
                marketModalValues.units.push( {id: unitTypeId, count: unitCount, tileId: DEFAULT_TILE} );
            }
        }

        const newTechnologyCount = getSelectedOption( "technologySelect" ).index;
        const newTechnologyIds = TECHNOLOGIES.filter( t => !marketModalValues.advancements.technologies.includes( t.id ) ).slice( 0, newTechnologyCount ).map( t => t.id );
        const newDoctrineCount = getSelectedOption( "doctrineSelect" ).index;
        const newDoctrineIds = DOCTRINES.filter( d => !marketModalValues.advancements.doctrines.includes( d.id ) ).slice( 0, newDoctrineCount ).map( d => d.id );
        const newGardenIds = nm('gardens').filter( c => c.checked ).map( c => c.id.split('-')[1] );
        const newAuctionIds = nm('auctions').filter( c => c.checked ).map( c => c.id.split('-')[1] );
        marketModalValues.advancements.technologies = marketModalValues.advancements.technologies.concat( newTechnologyIds );
        marketModalValues.advancements.doctrines    = marketModalValues.advancements.doctrines.concat( newDoctrineIds );
        marketModalValues.advancements.gardens      = marketModalValues.advancements.gardens.concat( newGardenIds );
        marketModalValues.advancements.auctions     = marketModalValues.advancements.auctions.concat( newAuctionIds );

        const newCards = Deck.getCurrentDeck( CHAOS, game.players.map( p => p.cards.chaos.map( c => c.id ) ) ).getRandomCards( parseInt( id('cardCount').value ) ).map( c => c.id );
        marketModalValues.cards.chaos = marketModalValues.cards.chaos.concat( newCards );
    }

    function clearTotals() {
        id('unitsCost').innerText      = "0";
        id('technologyCost').innerText = "0";
        id('doctrineCost').innerText   = "0";
        id('gardensCost').innerText    = "0";
        id('auctionsCost').innerText   = "0";
        id('cardCost').innerText       = "0";
        id('totalCost').innerText      = "0";
    }

    function closeOutMarketModal() {
        clearTotals();
        closeModalJS( "marketModal" );
        marketModalCallback( marketModalValues );
    }
</script>